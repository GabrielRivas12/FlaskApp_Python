{% extends "baseadmin.html" %}

{% block titulo %} Editar Productos {% endblock titulo %}

{% block body %}
<!--MENSAJE DE ALERTA SweetAlert2 CONFIRMACION-->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<ul class=flashes>
    {% for category, message in messages %}
    <script type="text/javascript">
        const Toast = Swal.mixin({
            toast: true,
            position: "top-end",
            showConfirmButton: false,
            timer: 2000,

            timerProgressBar: true,
            didOpen: (toast) => {
                toast.onmouseenter = Swal.stopTimer;
                toast.onmouseleave = Swal.resumeTimer;
            }
        });
        Toast.fire({
            icon: "success",
            title: "{{message}}"
        });
    </script>
    {% endfor %}
</ul>
{% endif %}
{% endwith %}

<div class="container mt-4">

    <!-- Encabezado -->
    <div class="bg-primary bg-gradient text-white rounded p-3 mb-3 shadow-sm">
        <h2 class="text-center">Lista de Productos</h2>
    </div>

    <!-- Contenedor para buscador y botones de exportación -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <!-- Botones de Exportación -->
        <div>
            <button id="btnCopiar" class="btn btn-outline-secondary btn-sm" title="Copiar"><i
                    class="bi bi-clipboard"></i></button>
            <button id="btnExcel" class="btn btn-outline-secondary btn-sm" title="Exportar a Excel"><i
                    class="bi bi-file-earmark-excel"></i></button>
            <button id="btnPDF" class="btn btn-outline-secondary btn-sm" title="Exportar a PDF"><i
                    class="bi bi-file-earmark-pdf"></i></button>
            <button id="btnImprimir" class="btn btn-outline-secondary btn-sm" title="Imprimir"><i
                    class="bi bi-printer"></i></button>
        </div>

        <!-- Contenedor para buscador y combo box de cantidad -->
        <div class="d-flex align-items-center gap-2">
            <!-- Combo Box para seleccionar cantidad por página -->
            <form method="GET" action="{{ url_for('editar') }}" class="d-flex align-items-center">
                <label for="por_pagina" class="form-label mb-0 me-2 small">Mostrar:</label>
                <select name="por_pagina" id="por_pagina" class="form-select form-select-sm" style="width: 80px;" onchange="this.form.submit()">
                    <option value="5" {% if request.args.get('por_pagina', '5') == '5' %}selected{% endif %}>5</option>
                    <option value="10" {% if request.args.get('por_pagina', '5') == '10' %}selected{% endif %}>10</option>
                    <option value="25" {% if request.args.get('por_pagina', '5') == '25' %}selected{% endif %}>25</option>
                    <option value="50" {% if request.args.get('por_pagina', '5') == '50' %}selected{% endif %}>50</option>
                    <option value="100" {% if request.args.get('por_pagina', '5') == '100' %}selected{% endif %}>100</option>
                </select>
                <!-- Mantener el parámetro de búsqueda si existe -->
                {% if request.args.get('buscar') %}
                <input type="hidden" name="buscar" value="{{ request.args.get('buscar') }}">
                {% endif %}
            </form>

            <!-- Buscador pequeño -->
            <form method="GET" action="{{ url_for('editar') }}" class="d-flex">
                <input type="text" class="form-control form-control-sm me-2" id="buscar" name="buscar"
                    value="{{ request.args.get('buscar', '') }}" placeholder="Buscar producto..." style="width: 200px;">
                <button type="submit" class="btn btn-primary btn-sm">
                    <i class="bi bi-search"></i>
                </button>
                {% if request.args.get('buscar') %}
                <a href="{{ url_for('editar') }}" class="btn btn-outline-danger btn-sm ms-2" title="Limpiar filtro">
                    <i class="bi bi-x-circle"></i>
                </a>
                {% endif %}
                <!-- Mantener el parámetro de cantidad por página si existe -->
                {% if request.args.get('por_pagina') %}
                <input type="hidden" name="por_pagina" value="{{ request.args.get('por_pagina') }}">
                {% endif %}
            </form>
        </div>
    </div>

    <!-- Tabla de Productos -->
    <div class="table-responsive">
        <table id="tablaProductos" class="table table-bordered table-striped text-center align-middle">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Precio</th>
                    <th>Descripción</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for producto in productos.items %}
                <tr>
                    <td>{{ producto.id }}</td>
                    <td>{{ producto.nombre }}</td>
                    <td>${{ "%.2f"|format(producto.precio) }}</td>
                    <td>{{ producto.descripcion }}</td>
                    <td>
                        <!-- Botón Editar -->
                        <button class="btn btn-success btn-sm" data-bs-toggle="modal"
                            data-bs-target="#modalEditar{{ producto.id }}">
                            <i class="bi bi-pencil"></i> 
                        </button>
                        <!-- Botón Eliminar - MODIFICADO: Ahora usa SweetAlert -->
                        <button class="btn btn-danger btn-sm btn-eliminar" 
                                data-url="{{ url_for('eliminar_producto', id=producto.id) }}"
                                data-nombre="{{ producto.nombre }}">
                            <i class="bi bi-trash"></i> 
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Información de resultados -->
    {% if request.args.get('buscar') %}
    <div class="alert alert-info py-2">
        <small>
            Resultados para: "<strong>{{ request.args.get('buscar') }}</strong>"
            | Página <strong>{{ productos.page }}</strong> de <strong>{{ productos.pages }}</strong>
        </small>
    </div>
    {% else %}
    <div class="alert alert-info py-2 d-flex justify-content-between align-items-center">
        <small>
            Mostrando <strong>{{ productos.items|length }}</strong> de <strong>{{ productos.total }}</strong> productos
        </small>
        <small>
            Página <strong>{{ productos.page }}</strong> de <strong>{{ productos.pages }}</strong>
        </small>
    </div>
    {% endif %}

    <!-- Paginador - MODIFICADO: Alineado a la derecha -->
    {% if productos.pages > 1 %}
    <nav aria-label="Paginación de productos">
        <ul class="pagination justify-content-end">
            <!-- Botón Anterior -->
            <li class="page-item {% if not productos.has_prev %}disabled{% endif %}">
                <a class="page-link"
                    href="{{ url_for('editar', page=productos.prev_num, buscar=request.args.get('buscar', ''), por_pagina=request.args.get('por_pagina', '5')) }}"
                    aria-label="Anterior">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>

            <!-- Páginas -->
            {% for page_num in productos.iter_pages(left_edge=2, left_current=2, right_current=3, right_edge=2) %}
            {% if page_num %}
            <li class="page-item {% if page_num == productos.page %}active{% endif %}">
                <a class="page-link"
                    href="{{ url_for('editar', page=page_num, buscar=request.args.get('buscar', ''), por_pagina=request.args.get('por_pagina', '5')) }}">
                    {{ page_num }}
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">...</span>
            </li>
            {% endif %}
            {% endfor %}

            <!-- Botón Siguiente -->
            <li class="page-item {% if not productos.has_next %}disabled{% endif %}">
                <a class="page-link"
                    href="{{ url_for('editar', page=productos.next_num, buscar=request.args.get('buscar', ''), por_pagina=request.args.get('por_pagina', '5')) }}"
                    aria-label="Siguiente">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
        </ul>
    </nav>
    {% endif %}
</div>

<!-- Modales de Edición (fuera de la tabla) -->
{% for producto in productos.items %}
<div class="modal fade" id="modalEditar{{ producto.id }}" tabindex="-1" aria-labelledby="modalLabel{{ producto.id }}"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('editar_producto_modal', id=producto.id) }}">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="modalLabel{{ producto.id }}">Editar Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nombre</label>
                        <input type="text" name="nombre" class="form-control" value="{{ producto.nombre }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Precio</label>
                        <input type="number" step="0.01" name="precio" class="form-control"
                            value="{{ producto.precio }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <textarea name="descripcion" class="form-control" rows="3"
                            required>{{ producto.descripcion }}</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- Scripts necesarios para las exportaciones -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const tabla = document.getElementById("tablaProductos");

        // 📋 COPIAR
        document.getElementById("btnCopiar").addEventListener("click", function () {
            let texto = "";
            tabla.querySelectorAll("tr").forEach(fila => {
                const celdas = Array.from(fila.querySelectorAll("th, td"))
                    .map(td => td.innerText.trim())
                    .filter((_, index) => index !== 4); // Excluir columna de acciones
                texto += celdas.join("\t") + "\n";
            });

            navigator.clipboard.writeText(texto).then(() => {
                alert("Tabla copiada al portapapeles ✅");
            }).catch(err => {
                console.error('Error al copiar: ', err);
                alert("Error al copiar la tabla");
            });
        });

        // 📊 EXPORTAR A EXCEL
        document.getElementById("btnExcel").addEventListener("click", function () {
            // Clonar la tabla para eliminar la columna de acciones
            const tablaClonada = tabla.cloneNode(true);
            tablaClonada.querySelectorAll('tr').forEach(fila => {
                const celdas = fila.querySelectorAll('th, td');
                if (celdas.length > 4) {
                    celdas[4].remove(); // Eliminar columna de acciones
                }
            });

            const wb = XLSX.utils.table_to_book(tablaClonada, { sheet: "Productos" });
            XLSX.writeFile(wb, "productos.xlsx");
        });

        // 📄 EXPORTAR A PDF
        document.getElementById("btnPDF").addEventListener("click", function () {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.text("Lista de Productos", 14, 10);

            // Preparar datos excluyendo la columna de acciones
            const headers = [];
            const rows = [];

            // Encabezados (excluyendo "Acciones")
            tabla.querySelectorAll('thead th').forEach((th, index) => {
                if (index !== 4) { // Excluir columna de acciones
                    headers.push(th.innerText);
                }
            });

            // Filas de datos
            tabla.querySelectorAll('tbody tr').forEach(tr => {
                const row = [];
                tr.querySelectorAll('td').forEach((td, index) => {
                    if (index !== 4) { // Excluir columna de acciones
                        row.push(td.innerText);
                    }
                });
                rows.push(row);
            });

            doc.autoTable({
                head: [headers],
                body: rows,
                startY: 20,
                styles: { fontSize: 10 },
                headStyles: { fillColor: [13, 110, 253] }
            });

            doc.save("productos.pdf");
        });

        // 🖨️ IMPRIMIR
        document.getElementById("btnImprimir").addEventListener("click", function () {
            const printWindow = window.open("", "_blank");
            const tablaClonada = tabla.cloneNode(true);

            // Remover columna de acciones para impresión
            tablaClonada.querySelectorAll('tr').forEach(fila => {
                const celdas = fila.querySelectorAll('th, td');
                if (celdas.length > 4) {
                    celdas[4].remove();
                }
            });

            printWindow.document.write(`
            <html>
                <head>
                    <title>Lista de Productos</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                    <style>
                        body { padding: 20px; }
                        h2 { color: #0d6efd; margin-bottom: 20px; }
                        @media print {
                            .table { font-size: 12px; }
                        }
                    </style>
                </head>
                <body>
                    <h2 class="text-center">Lista de Productos</h2>
                    ${tablaClonada.outerHTML}
                    <script>
                        window.onload = function() { 
                            window.print(); 
                            setTimeout(function() { window.close(); }, 100);
                        }
                    <\/script>
                </body>
            </html>
        `);
            printWindow.document.close();
        });

        // 🗑️ ELIMINAR PRODUCTO CON SWEETALERT - NUEVA FUNCIONALIDAD
        document.querySelectorAll('.btn-eliminar').forEach(button => {
            button.addEventListener('click', function() {
                const url = this.getAttribute('data-url');
                const nombre = this.getAttribute('data-nombre');
                
                Swal.fire({
                    title: '¿Estás seguro?',
                    html: `¿Deseas eliminar el producto <strong>"${nombre}"</strong>?<br><small>Esta acción no se puede deshacer.</small>`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Sí, eliminar',
                    cancelButtonText: 'Cancelar',
                    reverseButtons: true,
                    customClass: {
                        confirmButton: 'btn btn-danger mx-2',
                        cancelButton: 'btn btn-secondary mx-2'
                    },
                    buttonsStyling: false
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Mostrar mensaje de confirmación antes de redirigir
                        Swal.fire({
                            title: '¡Eliminado!',
                            text: `El producto "${nombre}" ha sido eliminado correctamente.`,
                            icon: 'success',
                            timer: 2000,
                            showConfirmButton: false
                        }).then(() => {
                            // Redirigir a la URL de eliminación
                            window.location.href = url;
                        });
                    }
                });
            });
        });
    });
</script>

{% endblock %}